version: "3.9"

services:
  # ============================================
  # Backend - FastAPI Application
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: luzia-backend
    ports:
      - "8000:8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    environment:
      - MONGO_URI=mongodb://mongo:27017/LuzIA
      - MONGO_DB_NAME=${MONGO_DB_NAME:-LuzIA}
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY:-changeme}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-120}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:8080}
    volumes:
      # Mount source code for hot-reload in development
      - ./backend/src:/app/src:ro
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - luzia-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # ============================================
    # MongoDB - Database
    # ============================================
  mongo:
    image: mongo:7
    container_name: luzia-mongo
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db
      - ./backend/mongo/init_final.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - luzia-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Redis - Cache & Celery Broker
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: luzia-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - luzia-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
  # ============================================
  # Celery Worker - Async Task Processing
  # (Uncomment when app.worker module is created)
  # ============================================
  # celery-worker:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile
  #   container_name: luzia-celery
  #   command: celery -A app.worker worker --loglevel=info
  #   environment:
  #     - MONGO_URI=mongodb://mongo:27017
  #     - MONGO_DB_NAME=${MONGO_DB_NAME:-LuzIA}
  #     - REDIS_URL=redis://redis:6379
  #     - SECRET_KEY=${SECRET_KEY:-changeme}
  #     - ENVIRONMENT=${ENVIRONMENT:-development}
  #   depends_on:
  #     - redis
  #     - mongo
  #   networks:
  #     - luzia-network
  #   restart: unless-stopped

  # ============================================
  # Volumes - Persistent Data Storage
  # ============================================
volumes:
  mongo_data:
    driver: local
  redis_data:
    driver: local

# ============================================
# Networks - Isolated Communication
# ============================================
networks:
  luzia-network:
    driver: bridge
